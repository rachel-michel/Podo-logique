<div id="configuration" class="mb-4">
  <form @submit.prevent="onEditPdfParameter">
    <div class="row pb-4 gy-4">
      <div class="text-center">
        <span class="h4">En-tête du compte rendu</span>
      </div>
      <div class="col-12 pb-3">
        <label for="office" class="form-label title">Informations du cabinet</label>
        <span class="text-muted">(Nom, adresse, mail, téléphone)</span>
        <textarea class="form-control" id="office" rows="5" x-model="pdfParameter.office"></textarea>
      </div>

      <span class="title">Informations du prescripteur</span>

      <div class="col-12 col-sm-4">
        <label for="prescriberFullname" class="form-label">Nom complet</label>
        <input class="form-control border-bottom" id="prescriberFullname" x-model="pdfParameter.prescriberFullname" />

        <!-- SUGGESTION -->
        <ul class="list-group w-100 z-10" x-show="getPrescribers().length > 0">
          <template x-for="p in getPrescribers()" :key="p.fullname">
            <li class="list-group-item list-group-item-action" @click="onSelectPrescriber(p)">
              <span x-text="p.fullname"></span>
            </li>
          </template>
        </ul>
      </div>

      <div class="col-12 col-sm-4">
        <label for="prescriberMail" class="form-label">Mail</label>
        <input class="form-control" id="prescriberMail" x-model="pdfParameter.prescriberMail" />
      </div>

      <div class="col-12 col-sm-4">
        <label for="prescriberPhoneNumber" class="form-label">Téléphone</label>
        <input class="form-control" id="prescriberPhoneNumber" x-model="pdfParameter.prescriberPhoneNumber" />
      </div>

      <div class="col-12 pb-3 border-bottom">
        <label for="prescriberAddress" class="form-label">Adresse</label>
        <textarea
          class="form-control"
          id="prescriberAddress"
          rows="3"
          x-model="pdfParameter.prescriberAddress"
        ></textarea>
      </div>

      <div class="text-center">
        <span class="h4">Corps du compte rendu</span>
      </div>

      <div class="col-12 text-muted pb-1">
        <span>
          Variables disponibles : {genre}, {nom_complet}, {nom}, {date_de_naissance}, {date_creation_dossier},
          {date_aujourdhui}.
        </span>
      </div>

      <div class="col-12">
        <label for="subject" class="form-label title">Objet</label>
        <input type="text" class="form-control" id="subject" x-model="pdfParameter.subject" />
      </div>

      <div class="col-12">
        <label for="content" class="form-label title">Contenu</label>
        <textarea class="form-control" id="content" rows="10" x-model="pdfParameter.content"></textarea>
      </div>

      <div class="col-12 pb-3 border-bottom">
        <label for="notesPrescriber" class="form-label title">Notes pour le médecin</label>
        <textarea class="form-control" id="notesPrescriber" rows="3" x-model="pdfParameter.notes"></textarea>
      </div>

      <div class="col-12">
        <div class="mb-3 text-center">
          <span class="h4">Afficher les tableaux d'examens</span>
        </div>

        <div class="d-flex flex-wrap">
          <div class="form-check form-switch col-12 col-sm-6">
            <input class="form-check-input" type="checkbox" id="switchExamenVisuel" x-model="pdfParameter.showTabA" />
            <label class="form-check-label" for="switchExamenVisuel">Examen visuel</label>
          </div>

          <div class="form-check form-switch col-12 col-sm-6">
            <input
              class="form-check-input"
              type="checkbox"
              id="switchExamenPalpatoire"
              x-model="pdfParameter.showTabB"
            />
            <label class="form-check-label" for="switchExamenPalpatoire">Examen palpatoire</label>
          </div>

          <div class="form-check form-switch col-12 col-sm-6">
            <input
              class="form-check-input"
              type="checkbox"
              id="switchExamenPodoscopique"
              x-model="pdfParameter.showTabC"
            />
            <label class="form-check-label" for="switchExamenPodoscopique">Examen podoscopique</label>
          </div>

          <div class="form-check form-switch col-12 col-sm-6 pb-3">
            <input class="form-check-input" type="checkbox" id="switchEtudeMarche" x-model="pdfParameter.showTabD" />
            <label class="form-check-label" for="switchEtudeMarche">Étude de la marche</label>
          </div>
        </div>
      </div>

      <div class="text-center border-bottom pb-4">
        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
      </div>
    </div>
  </form>
</div>

<div id="pdfTemplateWrapper">
  <div id="pdfTemplate" x-ref="pdfTemplate">
    <!-- HEADER -->
    <div class="header">
      <div
        class="logo"
        x-data="{ visible: false }"
        x-show="visible"
        style="display: none"
        x-init="$nextTick(() => { if ($refs.img.complete && $refs.img.naturalWidth > 0) visible = true })"
      >
        <img x-ref="img" src="assets/logo.png" alt="logo" @load="visible = true" @error="visible = false" />
      </div>

      <!-- Expéditeur : nom de l'établissement, adresse, email, téléphone -->
      <div class="sender">
        <span x-text="pdfParameter.office" style="white-space: pre-line"></span>
      </div>

      <!-- Destinataire : le médecin -->
      <div class="recipient">
        <span x-text="pdfParameter.prescriberFullname"></span>
        <span x-text="pdfParameter.prescriberAddress" style="white-space: pre-line"></span>
        <span x-text="pdfParameter.prescriberMail"></span>
        <span x-text="pdfParameter.prescriberPhoneNumber"></span>
      </div>
    </div>

    <!-- OBJET -->
    <div class="subject">
      <span x-text="replaceVariable(pdfParameter.subject)"></span>
    </div>

    <!-- CONTENU -->
    <div class="content">
      <span x-text="replaceVariable(pdfParameter.content)" style="white-space: pre-line"></span>
    </div>

    <!-- LAYOUT TABLE + NOTES (GAUCHE) / PLAN (DROITE) -->
    <div class="equipment-layout" :class="{ 'equipment-layout--full': !isEquipmentInclude('Orthèses plantaires') }">
      <div class="equipment-left">
        <!-- TABLEAU APPAREILLAGE -->
        <table>
          <colgroup>
            <col style="width: 60%" />
            <col style="width: 40%" />
          </colgroup>

          <thead>
            <tr>
              <th>Appareillage</th>
              <th>Details</th>
            </tr>
          </thead>

          <tbody>
            <template x-for="(row, index) in getEquipmentPlan" :key="index">
              <tr>
                <td>
                  <div>
                    <template x-for="part in getSplitedInput(row, 'localisation')" :key="part">
                      <div x-text="part"></div>
                    </template>
                  </div>
                </td>

                <td>
                  <div>
                    <template x-for="obs in getSplitedInput(row, 'observation')" :key="obs">
                      <div x-text="obs"></div>
                    </template>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>

        <!-- NOTES AU MEDECIN -->
        <div class="notes" x-cloak x-show="(pdfParameter.notes ?? '').trim() !== ''">
          <span style="font-weight: bold">Notes :</span>
          <span x-text="pdfParameter.notes"></span>
        </div>
      </div>

      <!-- PLAN D'APPAREILLAGE -->
      <div class="equipment-right" x-show="isEquipmentInclude('Orthèses plantaires')">
        <div class="equipment-plan">
          <img src="assets/equipment-plan/semelle-base.png" />
          <img x-show="isEquipmentInclude('Talonnette')" src="assets/equipment-plan/talonnette.png" />
          <img x-show="isEquipmentInclude('SAC - sous antéro capital long')" src="assets/equipment-plan/sac-long.png" />
          <img
            x-show="isEquipmentInclude('SAC - sous antéro capital court')"
            src="assets/equipment-plan/sac-court.png"
          />
          <img
            x-show="isEquipmentInclude('BAC - barre antéro capitale totale')"
            src="assets/equipment-plan/bac-totale.png"
          />
          <img x-show="isEquipmentInclude('Décharge de l\'hallux')" src="assets/equipment-plan/decharge-1.png" />
          <img x-show="isEquipmentInclude('Décharge des orteils 1-2')" src="assets/equipment-plan/decharge-1-2.png" />
          <img x-show="isEquipmentInclude('Décharge du 2eme orteil')" src="assets/equipment-plan/decharge-2.png" />
          <img x-show="isEquipmentInclude('Décharge des orteils 2-3')" src="assets/equipment-plan/decharge-2-3.png" />
          <img
            x-show="isEquipmentInclude('Décharge des orteils 2-3-4')"
            src="assets/equipment-plan/decharge-2-3-4.png"
          />
          <img x-show="isEquipmentInclude('Décharge du 3eme orteil')" src="assets/equipment-plan/decharge-3.png" />
          <img x-show="isEquipmentInclude('Décharge des orteils 3-4')" src="assets/equipment-plan/decharge-3-4.png" />
          <img
            x-show="isEquipmentInclude('Décharge des orteils 3-4-5')"
            src="assets/equipment-plan/decharge-3-4-5.png"
          />
          <img x-show="isEquipmentInclude('Décharge du 4eme orteil')" src="assets/equipment-plan/decharge-4.png" />
          <img x-show="isEquipmentInclude('Décharge des orteils 4-5')" src="assets/equipment-plan/decharge-4-5.png" />
          <img x-show="isEquipmentInclude('Décharge du 5eme orteil')" src="assets/equipment-plan/decharge-5.png" />

          <img x-show="isEquipmentInclude('CPP - coin pronateur postérieur')" src="assets/equipment-plan/cpp.png" />
          <img x-show="isEquipmentInclude('CSP - coin supinateur postérieur')" src="assets/equipment-plan/csp.png" />
          <img x-show="isEquipmentInclude('EPT - élément pronateur total')" src="assets/equipment-plan/ept.png" />
          <img x-show="isEquipmentInclude('Anneau neutre')" src="assets/equipment-plan/anneau-neutre.png" />
          <img x-show="isEquipmentInclude('Anneau pronateur')" src="assets/equipment-plan/anneau-pronateur.png" />
          <img x-show="isEquipmentInclude('Anneau supinateur')" src="assets/equipment-plan/anneau-supinateur.png" />
          <img x-show="isEquipmentInclude('ESP - élément supinateur postérieur')" src="assets/equipment-plan/esp.png" />
          <img x-show="isEquipmentInclude('EPP - élément pronateur postérieur')" src="assets/equipment-plan/epp.png" />
          <img x-show="isEquipmentInclude('Sous naviculaire')" src="assets/equipment-plan/sous-naviculaire.png" />
          <img x-show="isEquipmentInclude('Sous cuboïdien')" src="assets/equipment-plan/sous-cuboidien.png" />
          <img x-show="isEquipmentInclude('EPA - élément pronateur antérieur')" src="assets/equipment-plan/epa.png" />
          <img x-show="isEquipmentInclude('BRC - Barre rétro capital')" src="assets/equipment-plan/brc.png" />
          <img x-show="isEquipmentInclude('Voûte')" src="assets/equipment-plan/voute.png" />
          <img x-show="isEquipmentInclude('Arciforme')" src="assets/equipment-plan/arciforme.png" />
          <img
            x-show="isEquipmentInclude('Hémicoupole de décharge de l\'hallux')"
            src="assets/equipment-plan/hemicoupole-decharge.png"
          />
          <img x-show="isEquipmentInclude('ARCM - appui retro capital médian')" src="assets/equipment-plan/arcm.png" />
          <img
            x-show="isEquipmentInclude('Barre sous diaphysaire')"
            src="assets/equipment-plan/barre-sous-diaphysaire.png"
          />
          <img src="assets/equipment-plan/semelle-contour.png" />
        </div>
      </div>
    </div>

    <div x-cloak x-show="isShowAtLeastOneExamination()">
      <span x-text="'Détail des examens'" class="details-title"></span>
    </div>

    <!-- TABLEAU D'EXAMEN -->
    <template x-for="examen in getExaminations()" :key="examen.name">
      <template x-if="examen.show">
        <div class="examen">
          <span class="examen-title" x-text="examen.name"></span>

          <table>
            <colgroup>
              <col style="width: 30%" />
              <col style="width: 70%" />
            </colgroup>

            <thead>
              <tr>
                <th>Localisation</th>
                <th>Observation</th>
              </tr>
            </thead>

            <tbody>
              <template x-for="(row, index) in examen.rows" :key="index">
                <tr>
                  <td>
                    <div>
                      <template x-for="part in getSplitedInput(row, 'localisation')" :key="part">
                        <div x-text="part"></div>
                      </template>
                    </div>
                  </td>

                  <td>
                    <div>
                      <template x-for="obs in getSplitedInput(row, 'observation')" :key="obs">
                        <div x-text="obs"></div>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>
    </template>
  </div>
</div>

<div class="d-flex justify-content-around">
  <button type="button" @click="window.print()" class="btn btn-primary">Générer le PDF</button>
  <button type="button" @click="onSendToMail()" class="btn btn-primary">Envoyer un email</button>
</div>
